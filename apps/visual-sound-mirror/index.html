<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Sound Mirror</title>
    <link rel="stylesheet" href="styles.css">
    <!-- MediaPipe for hand tracking -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>
    <div id="container">
        <canvas id="canvas"></canvas>
        <video id="video" autoplay playsinline muted></video>

        <div id="overlay" class="active">
            <div id="welcome">
                <h1>Visual Sound Mirror</h1>
                <p>A hands-free interactive music instrument. Use hand gestures to switch modes and control sound - no keyboard required!</p>
                <button id="startButton">Begin Experience</button>
                <p class="hint">Camera and audio permissions required</p>
            </div>
        </div>

        <div id="controls">
            <div class="mode-switcher">
                <button class="mode-btn" data-mode="ribbons" title="Ribbons Mode (Show 1 finger)">üé®</button>
                <button class="mode-btn" data-mode="theremin" title="Theremin Mode (Show 2 fingers)">üéµ</button>
                <button class="mode-btn" data-mode="pads" title="Sample Pads Mode (Show 5 fingers)">ü•Å</button>
            </div>
            <div class="control-buttons">
                <button id="muteButton" title="Toggle Audio">üîä</button>
                <button id="debugButton" title="Toggle Debug">üîç</button>
                <button id="infoButton" title="Info">‚ÑπÔ∏è</button>
            </div>
        </div>

        <div id="debug" class="hidden">
            <div class="debug-panel">
                <h3>Debug Info</h3>
                <p>Motion Intensity: <span id="debugMotion">0</span></p>
                <p>Position: <span id="debugPosition">0, 0</span></p>
                <p>Particles: <span id="debugParticles">0</span></p>
                <p>Audio: <span id="debugAudio">Initializing...</span></p>
                <p>Hands Detected: <span id="debugHands">0</span></p>
            </div>
        </div>

        <div id="padDebugPanel" class="hidden">
            <div class="pad-debug-content">
                <h3>Pad Tuning (Press 'P' to toggle)</h3>

                <div class="control-group">
                    <label>Tap Algorithm:</label>
                    <select id="tapAlgorithm">
                        <option value="z-velocity">Z-Velocity (forward motion)</option>
                        <option value="dwell-retreat">Dwell + Retreat</option>
                        <option value="wiggle">Wiggle (XY movement)</option>
                        <option value="hybrid">Hybrid (Z + wiggle)</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Pad Size: <span id="padSizeValue">70</span>px</label>
                    <input type="range" id="padSize" min="40" max="120" value="70" step="5">
                </div>

                <div class="control-group">
                    <label>Spacing Multiplier: <span id="spacingValue">0.8</span>x</label>
                    <input type="range" id="spacing" min="0.5" max="2.0" value="0.8" step="0.1">
                </div>

                <div class="control-group">
                    <label>Z Threshold: <span id="zThresholdValue">0.02</span></label>
                    <input type="range" id="zThreshold" min="0.005" max="0.1" value="0.02" step="0.005">
                </div>

                <div class="control-group">
                    <label>Dwell Time: <span id="dwellTimeValue">200</span>ms</label>
                    <input type="range" id="dwellTime" min="100" max="500" value="200" step="50">
                </div>

                <div class="control-group">
                    <label>Wiggle Threshold: <span id="wiggleValue">10</span>px</label>
                    <input type="range" id="wiggle" min="5" max="30" value="10" step="1">
                </div>

                <div class="control-group">
                    <label>Retreat Threshold: <span id="retreatValue">0.02</span></label>
                    <input type="range" id="retreat" min="0.01" max="0.05" value="0.02" step="0.005">
                </div>

                <div class="control-group">
                    <label>Retrigger Delay: <span id="retriggerDelayValue">100</span>ms</label>
                    <input type="range" id="retriggerDelay" min="50" max="300" value="100" step="10">
                </div>

                <button id="resetPads">Reset to Defaults</button>
                <button id="recalibrate">Recalibrate Pads</button>
            </div>
        </div>

        <div id="vizDebugPanel" class="hidden">
            <div class="viz-debug-content">
                <h3>Visualization Tuning (Press 'V' to toggle)</h3>
                <p class="viz-mode-indicator">Mode <span id="currentVizMode">1</span>: Particle Fountain | Press 1-6 to switch modes</p>

                <div class="control-group">
                    <label>Emission Rate: <span id="emissionRateValue">30</span>/sec</label>
                    <input type="range" id="emissionRate" min="10" max="200" value="30" step="5">
                </div>

                <div class="control-group">
                    <label>Lifetime: <span id="lifetimeValue">4000</span>ms</label>
                    <input type="range" id="lifetime" min="500" max="8000" value="4000" step="100">
                </div>

                <div class="control-group">
                    <label>Initial Velocity: <span id="initialVelocityValue">0.3</span>x</label>
                    <input type="range" id="initialVelocity" min="0.01" max="2.0" value="0.3" step="0.01">
                </div>

                <div class="control-group">
                    <label>Gravity: <span id="gravityValue">0.08</span></label>
                    <input type="range" id="gravity" min="0" max="0.5" value="0.08" step="0.01">
                </div>

                <div class="control-group">
                    <label>Drag: <span id="dragValue">0.995</span></label>
                    <input type="range" id="drag" min="0.9" max="0.999" value="0.995" step="0.001">
                </div>

                <div class="control-group">
                    <label>Attraction: <span id="attractionValue">0.0</span></label>
                    <input type="range" id="attraction" min="-0.5" max="0.5" value="0.0" step="0.05">
                </div>

                <div class="control-group">
                    <label>Repulsion: <span id="repulsionValue">0.0</span></label>
                    <input type="range" id="repulsion" min="0" max="2" value="0.0" step="0.1">
                </div>

                <div class="control-group">
                    <label>Turbulence: <span id="turbulenceValue">0.3</span></label>
                    <input type="range" id="turbulence" min="0" max="2" value="0.3" step="0.1">
                </div>

                <div class="control-group">
                    <label>Size Min: <span id="particleSizeMinValue">0.5</span>px</label>
                    <input type="range" id="particleSizeMin" min="0.5" max="5" value="0.5" step="0.1">
                </div>

                <div class="control-group">
                    <label>Size Max: <span id="particleSizeMaxValue">2.5</span>px</label>
                    <input type="range" id="particleSizeMax" min="1" max="10" value="2.5" step="0.1">
                </div>

                <div class="control-group">
                    <label>Color Mode:</label>
                    <select id="colorMode">
                        <option value="velocity">Velocity</option>
                        <option value="lifetime">Lifetime</option>
                        <option value="audio">Audio Reactive</option>
                        <option value="rainbow">Rainbow</option>
                    </select>
                </div>

                <div class="control-group checkbox-group">
                    <label><input type="checkbox" id="glow" checked> Glow Effect</label>
                    <label><input type="checkbox" id="trails"> Particle Trails</label>
                    <label><input type="checkbox" id="audioReactive" checked> Audio Reactive</label>
                </div>

                <div class="control-group">
                    <p>Particles: <span id="particleCount">0</span> / 15000</p>
                </div>

                <button id="clearParticles">Clear All Particles</button>
                <button id="resetViz">Reset to Defaults</button>
            </div>
        </div>

        <div id="info" class="hidden">
            <div class="info-content">
                <h2>Visual Sound Mirror - v6.6.0</h2>
                <h3>Hands-Free Edition</h3>

                <h4>Mode Switching (Right Hand Gestures)</h4>
                <p><strong>Hold gesture steady for 2.5 seconds to switch modes:</strong></p>
                <ul>
                    <li><strong>1 finger:</strong> Ribbons Mode üé®</li>
                    <li><strong>2 fingers (peace sign):</strong> Theremin Mode üéµ</li>
                    <li><strong>5 fingers (open hand):</strong> Sample Pads Mode ü•Å</li>
                </ul>
                <p><em>A circular progress indicator shows when gesture is being held.</em></p>

                <h4>Modes</h4>
                <ul>
                    <li><strong>üé® Ribbons:</strong> Flowing silk ribbons from your fingertips. Touch fingertips together for harmonic chords.</li>
                    <li><strong>üéµ Theremin:</strong> Play melodies with hand position. X-axis = pitch (quantized to scale), Y-axis = filter brightness.</li>
                    <li><strong>ü•Å Sample Pads:</strong> Auto-calibrates to your hand when entering mode. 5 pads per finger extending away from palm. <em>To trigger:</em> Move finger forward (toward camera) over a pad to tap it.</li>
                </ul>

                <h4>Global Controls (Always Active)</h4>
                <ul>
                    <li><strong>Knobs (top-left):</strong> Pinch thumb + index inside any knob to rotate. Controls Filter, Reverb, Delay, Resonance.</li>
                    <li><strong>üîä button:</strong> Toggle audio on/off</li>
                    <li><strong>üîç button:</strong> Toggle debug mode (shows hand tracking)</li>
                </ul>

                <h4>Gestures</h4>
                <ul>
                    <li><strong>Tap:</strong> Move finger forward (toward camera) to trigger pads</li>
                    <li><strong>Pinch:</strong> Thumb + index to control knobs</li>
                    <li><strong>Touch fingertips:</strong> Create harmonic chords (Ribbons mode)</li>
                </ul>

                <p class="privacy">üîí All processing happens locally - no data is recorded or transmitted</p>
                <button id="closeInfo">Close</button>
            </div>
        </div>

        <div id="status"></div>
    </div>

    <script src="app.js"></script>
</body>
</html>
